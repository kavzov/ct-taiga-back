{% extends "index.html" %}

{% block javascript %}
{{ block.super }}

<script type=text/javascript>

var users = getUsers();
var members = getMembers();
var roles = getRoles();
var members_roles = getMembersAndRoles();


/* Users */
function getUsers() {
    var users = {}
    {% for user in users %}
    users['{{ user.id }}'] = '{{ user.get_full_name }}';
    {% endfor %}
    return users;
}


/* Members */
function getMembers() {
    var members = [];
    {% for member in members %}
    members.push({{ member.user.id }});
    {% endfor %}
    return members;
}


/* Roles */
function getRoles() {
    var roles = {};
    {% for role in roles %}
    roles['{{ role.id }}'] = '{{ role.name }}';
    {% endfor %}
    return roles;
}


/* Members & Roles by users */
function getMembersAndRoles() {
    var members_roles = {};
    for (var i in members) {
        var user_id = members[i];
        members_roles[user_id] = [];
        {% for member, member_roles in members_roles.items %}
            if (user_id == {{ member.user.id }}) {
                {% for member_role in member_roles %}
                members_roles[user_id].push({{ member_role }});
                {% endfor %}
            }
        {% endfor %}
    }
    return members_roles;
}


/* Check either value in array */
function in_arr(val, arr) {
    for (var i=0; i<arr.length; i++) {
        if (arr[i] == val) { return true }
    }
    return false;
}


/* Display users list */
function displayUsersList() {
    var usersHTML = '';
    for (user_id in users) {
        if (in_arr(user_id, members)) { continue }
        usersHTML += '<span class="user-to-member-field" user_id="' + user_id +'">' + users[user_id] + '</span>';
    }
    $('#users-to-member').html(usersHTML);
}


/* Display members list with roles */
function displayMembersAndRoles() {
    var html = '';
    for (var member in members) {
        var userID = members[member];
        html += '<tr user="'+ userID +'">';
        html += '<td>' + users[userID] + '</td>';
        html += '<td>';
        for (var roleID in roles) {
        html += '<label><input type="checkbox" class="role-checkbox" name="member_'+ userID +'" value="' + roleID + '" ';
            for (var i in members_roles[userID]) {
                var memberRoleID = members_roles[userID][i];
                if (roleID == memberRoleID) {
                    html += 'checked="checked"';
                }
            }
        html += '>&nbsp;';
        html += roles[roleID];
        html += '</label>&ensp;';
        }
        html += '<span class="remove-member" user_id="'+ userID +'" style="color:#833; cursor:pointer;" title="Remove from project">&#9746;</span>';
        html += '\
            </td>\
            </tr>';
    }
    $('#test-members').html(html);
}

$(document).ready(function() {

    /* Initial display of users and members lists */
    displayUsersList();
    displayMembersAndRoles()


    /* Add a user to project */
    $('#users-to-member').on('click', '.user-to-member-field', function(){
        /* Pop user name from users list and push it to members list */

        // Add user id to members list
        var userID = parseInt($(this).attr('user_id'));
        members.push(userID);

        // Redisplay user and members lists
        displayUsersList();
        displayMembersAndRoles()
    });


    /* Remove member from project */
    $('#test-members').on('click', '.remove-member', function() {
        /* Pop user name from members list and push it to users list */

        // Remove member id from member list
        var userID = parseInt($(this).attr('user_id'));
        var index = members.indexOf(userID);
        members.splice(index, 1);

        // Redisplay user and members lists
        displayUsersList();
        displayMembersAndRoles()
    });


    /*
    * Add role to member (members_roles dict) after clicking on checkbox
    * It's necessary for save checks after lists redisplay
    */
    $('#test-members').on('click', '.role-checkbox', function() {
        var name = $(this).attr('name');
        var userID = name.match(/\d+$/);
        var role = $(this).val();
        alert(userID + ' : ' + role);
        // TODO
        // Add to members_roles: check if already member in it => add role, else add key - member and role to list
        // TODO
        // Try variant with appending members and users to its lists without redisplaying (using fadeToggle)
    });

});

</script>
{% endblock javascript %}

{% block content %}
    <!-- Project details -->
    <h2>
        Edit project &#35;{{ project.id }}
        {% if not editing %}
        <span style="display:inline-block; float:right; text-align:right; font-size:.65em; font-weight:normal; line-height:1.7em;">
            <a href="edit">Edit project</a>
        </span>
        {% endif %}
    </h2>

    <div id="edit-project-form">
        <form action="" method="post">
        {% csrf_token %}
        <table>
            <tr>
                <td><label for="id_name">Name:</label></td>
                <td><input id="id_name" maxlength="128" name="name" type="text" value="{{ project.name }}" required /></td>
            </tr>
            <tr>
                <td><label for="id_description">Description:</label></td>
                <td><textarea cols="40" id="id_description" maxlength="1024" name="description" rows="10" required>{{ project.description }}</textarea></td>
            </tr>
            <tr>
                <td><label for="id_owner">Owner:</label></td>
                <td><select id="id_owner" name="owner">
                    <option value=""> ------- </option>
                    {% for user in users %}
                    <option value="{{ user.id }}" {% if user.id == project.owner_id %}selected="selected"{% endif %}>{{ user.get_full_name }}</option>
                    {% endfor %}
                    </select>
                </td>
            </tr>
<!-- Members block -->
            <tr>
                <td>Members:</td>
                <td>
                    <table id="test-members">
                    </table>
                </td>
            </tr>
<!-- Members block -->
<!-- Search member block -->
            <tr>
                <td style="width:10%;">Add&nbsp;member:</td>
                <td style="line-height:1.5em;">
                    <input type="text" id="member-search-field" name="member">&nbsp;
                    <span id="roles-list">
                        {% for role in roles %}
                        <label><input type="checkbox" name="role" value="{{ role.id }}">{{ role.name }}</label>
                        {% endfor %}
                        &ensp;<span id="add-member" style="font-size:1.2em; color:#282; cursor:pointer;" title="Add to project">&#9745;</span>&nbsp; <span id="remove-candidate-member" style="font-size:1.2em; color:#822; cursor:pointer;" title="Clear">&#9746;</span>
                    </span>
                </td>
            </tr>
            <tr>
                <td>&nbsp;</td>
                <td id="users-to-member">
                </td>
            </tr>
<!-- END Search member block -->

            <tr>
                <td></td>
                <td style="text-align:center;"><input type="submit" value="Save" style="width:5em;"></td>
            </tr>

<!--
            {% with issue_change_perm='issues.change_issue' %}
            <tr>
                <td colspan="2">{% if user.is_authenticated %} User has ISSUE CHANGE permissions: {{ user_perms|unordered_list }} {% else %} NOT {{ user_perms }} {% endif %}</td>
            </tr>
            {% endwith %}
-->
        </table>
        </form>
    </div>

    <div id="test-output">
    {{ test_data }}
    </div>


{% endblock content %}
